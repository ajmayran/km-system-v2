{% extends 'base/admin-index.html' %}
{% load static %}
{% block title %}
  Admin Dashboard
{% endblock %}
{% block stylesheet %}
  <link rel="stylesheet" href="{% static 'assets/css/admin/admin.dashboard.css' %}" />
{% endblock %}

{% block content %}
  <div class="masonry-item w-100">
    <div class="row gap-20">
      <div class="col-md-3">
        <div class="layers bd bgc-white p-20">
          <div class="layer w-100 mB-10">
            <h6 class="lh-1">
              <a href="" style="color: gray;">User Accounts</a>
            </h6>
          </div>
          <div class="layer w-100">
            <div class="peers ai-sb fxw-nw">
              <div class="peer peer-greed">
                <span id="sparklinedash"></span>
              </div>
              <div class="peer">
                <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-green-50 c-green-500">
                  {{total_accounts|default:"0"}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="layers bd bgc-white p-20">
          <div class="layer w-100 mB-10">
            <h6 class="lh-1">Commodities</h6>
          </div>
          <div class="layer w-100">
            <div class="peers ai-sb fxw-nw">
              <div class="peer peer-greed">
                <span id="sparklinedash2"></span>
              </div>
              <div class="peer">
                <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-purple-50 c-purple-500">
                {{total_commodities|default:"0"}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="layers bd bgc-white p-20">
          <div class="layer w-100 mB-10">
            <h6 class="lh-1">CMI's</h6>
          </div>
          <div class="layer w-100">
            <div class="peers ai-sb fxw-nw">
              <div class="peer peer-greed">
                <span id="sparklinedash3"></span>
              </div>
              <div class="peer">
                <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-blue-50 c-blue-500">
               {{total_cmis|default:"0"}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-md-3">
        <div class="layers bd bgc-white p-20">
          <div class="layer w-100 mB-10">
            <h6 class="lh-1">Knowledge Resources</h6>
          </div>
          <div class="layer w-100">
            <div class="peers ai-sb fxw-nw">
              <div class="peer peer-greed">
                <span id="sparklinedash4"></span>
              </div>
              <div class="peer">
                <span class="d-ib lh-0 va-m fw-600 bdrs-10em pX-15 pY-15 bgc-red-50 c-red-500">
                {{total_resources|default:"0"}}
                </span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="masonry-item col-md-6">
    <div class="bd bgc-white">
      <div class="layers">
        <div class="layer w-100 pX-20 pT-20">
          <h6 class="lh-1">Forum Posts Monthly Count</h6>
        </div>
        <div class="layer w-100 p-20">
          <canvas id="line-chart" height="220"></canvas>
        </div>
        
        <div class="layer bdT p-20 w-100">
          <div class="peers ai-c jc-c gapX-20">
            <div class="peer">
              <span class="fsz-def fw-600 mR-10 c-grey-800">{{ stats.total_posts }}
                <i class="fa fa-level-{% if stats.total_trend == 'up' %}up c-green-500{% else %}down c-red-500{% endif %}"></i>
              </span>
              <small class="c-grey-500 fw-600">TOTAL</small>
            </div>
            <div class="peer fw-600">
              <span class="fsz-def fw-600 mR-10 c-grey-800">{{ stats.avg_percentage }}% 
                <i class="fa fa-level-{% if stats.avg_trend == 'up' %}up c-green-500{% else %}down c-red-500{% endif %}"></i>
              </span>
              <small class="c-grey-500 fw-600">Average</small>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Latest Messages Section with Outlines -->
  <div class="masonry-item col-md-6">
    <div class="bd bgc-white p-20">
      <div class="layers">
        <div class="layer w-100 mB-10">
          <h6 class="lh-1">Latest Messages</h6>
        </div>
        <div class="layer w-100">
          <div class="table-responsive">
            <table class="table table-bordered align-middle mb-0">
              <tbody>
                <!-- Message 1 -->
                <tr>
                  <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <div class="d-flex align-items-center">
                      <div>
                        <p class="fw-bold mb-1">John Doe</p>
                        <p class="text-muted mb-0 small">May 15, 2025 • 10:45 AM</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-end" style="border: 1px solid #dee2e6; width: 120px; padding: 12px;">
                    <span class="badge rounded-pill" style="background-color: #4CAF50; padding: 6px 12px;">Active</span>
                  </td>
                </tr>
                
                <!-- Message 2 -->
                <tr>
                  <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <div class="d-flex align-items-center">
                      <div>
                        <p class="fw-bold mb-1">Maria Santos</p>
                        <p class="text-muted mb-0 small">May 14, 2025 • 3:22 PM</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-end" style="border: 1px solid #dee2e6; width: 120px; padding: 12px;">
                    <span class="badge rounded-pill" style="background-color: #2196F3; padding: 6px 12px;">Processing</span>
                  </td>
                </tr>
                
                <!-- Message 3 -->
                <tr>
                  <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <div class="d-flex align-items-center">
                      <div>
                        <p class="fw-bold mb-1">Alex Rodriguez</p>
                        <p class="text-muted mb-0 small">May 13, 2025 • 9:15 AM</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-end" style="border: 1px solid #dee2e6; width: 120px; padding: 12px;">
                    <span class="badge rounded-pill" style="background-color: #FF9800; color: #212529; padding: 6px 12px;">Pending</span>
                  </td>
                </tr>
                
                <!-- Message 4 -->
                <tr>
                  <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <div class="d-flex align-items-center">
                      <div>
                        <p class="fw-bold mb-1">Lisa Tan</p>
                        <p class="text-muted mb-0 small">May 12, 2025 • 2:30 PM</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-end" style="border: 1px solid #dee2e6; width: 120px; padding: 12px;">
                    <span class="badge rounded-pill" style="background-color: #00BCD4; padding: 6px 12px;">Reviewing</span>
                  </td>
                </tr>
                
                <!-- Message 5 -->
                <tr>
                  <td style="border: 1px solid #dee2e6; padding: 12px;">
                    <div class="d-flex align-items-center">
                      <div>
                        <p class="fw-bold mb-1">Ryan Martinez</p>
                        <p class="text-muted mb-0 small">May 11, 2025 • 11:05 AM</p>
                      </div>
                    </div>
                  </td>
                  <td class="text-end" style="border: 1px solid #dee2e6; width: 120px; padding: 12px;">
                    <span class="badge rounded-pill" style="background-color: #9E9E9E; padding: 6px 12px;">Completed</span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="masonry-item col-12">
    <div class="bd bgc-white">
      <div class="peers fxw-nw@lg+ ai-s">
        <div class="peer peer-greed w-70p@lg+ w-100@lg- p-20">
          <div class="layers">
            <div class="layer w-100 mB-10">
              <h5 class="lh-1">Consortium Member Institution (CMI) Map</h5>
            </div>
            <div class="layer w-100">
              <div id="cmi-map" style="height: 600px; width: 100%; border-radius: 8px;"></div>
            </div>
          </div>
        </div>
        <div class="peer bdL p-20 w-30p@lg+ w-100p@lg-">
          <div class="layers">
            <div class="layer w-100">
              <div class="layers">
                <h5 class="mB-5">Top 10 Tagged Commodities</h5>
                {% for commodity in top_10_commodities %}
                <div class="layer w-100">
                  <small class="fw-600 c-grey-700">{{commodity.commodity_name}}</small>
                  <span class="pull-right c-grey-600 fsz-sm">{{ commodity.total_tags }}%</span>
                  <div class="progress mT-10">
                    <div class="progress-bar bgc-deep-purple-500" role="progressbar" aria-valuenow="{{ commodity.total_tags }}" aria-valuemin="0" aria-valuemax="100" style="width:{{ commodity.total_tags }}%;">
                      <span class="visually-hidden">{{ commodity.total_tags }}% Complete</span>
                    </div>
                  </div>
                </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
{% endblock %}

{% block script %}
  {% if messages %}
    {% for message in messages %}
      {% if message.tags == 'success' %}
        <script>
          // Display SweetAlert success message
          Swal.fire({
            icon: 'success',
            title: 'Success!',
            text: '{{ message }}'
          })
        </script>
      {% endif %}
    {% endfor %}
  {% endif %}
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      // Initialize the map centered on the Philippines
      var map = L.map('cmi-map').setView([12.099740, 122.244865], 5.5);
      
      // Add the OpenStreetMap tiles
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19,
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
      }).addTo(map);
      
      // Add markers for each CMI
      {% for cmi in cmis %}
        {% if cmi.latitude and cmi.longitude %}
          var marker = L.marker([{{ cmi.latitude }}, {{ cmi.longitude }}]).addTo(map);
          marker.bindPopup("<b>{{ cmi.cmi_name }}</b><br>{{ cmi.cmi_meaning|default:'' }}<br>{{ cmi.address|default:'' }}");
        {% endif %}
      {% endfor %}
      
      // Add scale control
      L.control.scale().addTo(map);

      // Get the canvas element
      const ctx = document.getElementById('line-chart').getContext('2d');
          
      // Chart data
      const monthLabels = [
          {% for month in stats.months_data %}
              '{{ month.month_name }}',
          {% endfor %}
      ];
      
      const postCounts = [
          {% for month in stats.months_data %}
              {{ month.total }},
          {% endfor %}
      ];
      
      // Create the chart
      new Chart(ctx, {
          type: 'line',
          data: {
              labels: monthLabels,
              datasets: [{
                  label: 'Forum Posts',
                  data: postCounts,
                  borderColor: '#3e95cd',
                  backgroundColor: 'rgba(62, 149, 205, 0.1)',
                  borderWidth: 2,
                  tension: 0.4,
                  fill: true,
                  pointBackgroundColor: '#3e95cd',
                  pointRadius: 4,
                  pointHoverRadius: 6
              }]
          },
          options: {
              responsive: true,
              maintainAspectRatio: false,
              plugins: {
                  legend: {
                      display: false
                  },
                  tooltip: {
                      mode: 'index',
                      intersect: false,
                      callbacks: {
                          title: function(tooltipItems) {
                              return tooltipItems[0].label + ' {{ current_year }}';
                          }
                      }
                  }
              },
              scales: {
                  y: {
                      beginAtZero: true,
                      ticks: {
                          precision: 0
                      },
                      grid: {
                          drawBorder: false
                      }
                  },
                  x: {
                      grid: {
                          display: false,
                          drawBorder: false
                      }
                  }
              }
          }
      });
    });
  </script>
{% endblock %}