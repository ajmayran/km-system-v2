{% extends 'base/cmi-index.html' %} 
{% load static %} 
{% block title %}KM4AANR Forum{% endblock %} 
{% block stylesheet %}
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
/>

<style>
  :root {
    --primary-color: #2e7d32;
    --primary-light: #60ad5e;
    --primary-dark: #005005;
    --text-on-primary: #ffffff;
    --secondary-color: #e8f5e9;
    --text-color: #333333;
    --border-color: #dddddd;
    --hover-color: #f5f5f5;
    --success-color: #4caf50;
    --info-color: #2196f3;
    --warning-color: #ff9800;
  }

  * {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
  }

  body {
    background-color: #f0f2f5;
    color: var(--text-color);
  }

  /* Header */
  header {
    background-color: var(--primary-color);
    color: var(--text-on-primary);
    padding: 1rem 2rem;
    display: flex;
    justify-content: space-between;
    align-items: center;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    display: flex;
    align-items: center;
  }

  .logo img {
    height: 40px;
    margin-right: 10px;
  }

  .logo-text {
    display: flex;
    flex-direction: column;
  }

  .logo-text h1 {
    font-size: 1.5rem;
    font-weight: 700;
    margin: 0;
  }

  .logo-text small {
    font-size: 0.75rem;
    text-transform: uppercase;
  }

  nav {
    display: flex;
    gap: 1rem;
  }

  nav a {
    color: var(--text-on-primary);
    text-decoration: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    font-weight: 500;
    transition: background-color 0.3s;
  }

  nav a:hover {
    background-color: rgba(255, 255, 255, 0.1);
  }

  nav a.active {
    background-color: rgba(255, 255, 255, 0.2);
  }

  .nav-icon {
    margin-right: 5px;
  }

  .user-actions {
    display: flex;
    align-items: center;
  }

  .user-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
  }

  /* Main Container */
  .container {
    max-width: 1200px;
    margin: 3rem auto;
    padding: 0 1rem;
  }

  /* Breadcrumb */
  .breadcrumb {
    display: flex;
    align-items: center;
    margin-top: 1rem;
    font-size: 0.9rem;
    background-color: #F0F2F5;
  }

  .breadcrumb a {
    color: var(--primary-color);
    text-decoration: none;
  }

  .breadcrumb span {
    margin: 0 0.5rem;
    color: #777;
  }

  /* Post Section */
  .post-container {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
    margin-bottom: 1.5rem;
  }

  .post-header {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .post-title {
    font-size: 1.5rem;
    color: var(--primary-dark);
    margin-bottom: 0.5rem;
    display: flex;
    align-items: center;
  }

  .post-title i {
    margin-left: 0.5rem;
    color: var(--success-color);
  }

  .post-category {
    display: inline-block;
    flex-wrap: wrap;
    gap: 0.6rem;
    color: var(--primary-dark);
    border-radius: 20px;
    font-size: 0.875rem;
    margin-bottom: 0.5rem;
  }

  .post-tag {
    background-color: rgba(44, 110, 73, 0.08);
    color: var(--primary);
    padding: 5px 12px;
    border-radius: 30px;
    font-size: 0.85rem;
    text-decoration: none;
    transition: var(--transition);
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    font-weight: 500;
  }

  .post-tag:hover {
    background-color: var(--primary);
    color: white;
    transform: translateY(-2px);
    box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);
  }

  .post-meta {
    display: flex;
    align-items: center;
    color: #777;
    font-size: 0.875rem;
  }

  .post-author {
    display: flex;
    align-items: center;
    margin-right: 1.5rem;
  }

  .author-avatar {
    width: 36px;
    height: 36px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    margin-right: 0.5rem;
    overflow: hidden;
  }

  .author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-date {
    display: flex;
    align-items: center;
  }

  .post-date i {
    margin-right: 0.25rem;
  }

  .post-content {
    padding: 1.5rem;
    line-height: 1.6;
  }

  .post-content p {
    margin-bottom: 1rem;
  }

  .post-content ul,
  .post-content ol {
    margin-left: 1.5rem;
    margin-bottom: 1rem;
  }

  .post-content li {
    margin-bottom: 0.5rem;
  }

  .post-content h3 {
    margin: 1.5rem 0 0.75rem;
    color: var(--primary-dark);
  }

  .topic-points {
    margin: 1rem 0;
  }

  .topic-item {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0.75rem;
  }

  .topic-item i {
    color: var(--success-color);
    margin-right: 0.5rem;
    margin-top: 0.25rem;
  }

  /* Post Actions */
  .post-actions {
    display: flex;
    padding: 1rem 1.5rem;
    border-top: 1px solid var(--border-color);
    background-color: #f9f9f9;
  }

  .action-button {
    display: flex;
    align-items: center;
    background: none;
    border: none;
    padding: 0.5rem 1rem;
    margin-right: 1rem;
    cursor: pointer;
    color: #555;
    font-size: 0.9rem;
    border-radius: 4px;
    transition: background-color 0.2s;
  }

  .action-button:hover {
    background-color: var(--hover-color);
  }

  .action-button i {
    margin-right: 0.5rem;
  }

  .action-button.liked {
    color: var(--primary-color);
  }

  .share-dropdown {
    position: relative;
  }

  .share-menu {
    position: absolute;
    bottom: 100%;
    left: 0;
    background-color: white;
    border-radius: 4px;
    box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
    padding: 0.5rem 0;
    min-width: 150px;
    z-index: 100;
    display: none;
  }

  .share-menu.active {
    display: block;
  }

  .share-menu a {
    display: flex;
    align-items: center;
    padding: 0.5rem 1rem;
    color: var(--text-color);
    text-decoration: none;
    transition: background-color 0.2s;
  }

  .share-menu a:hover {
    background-color: var(--hover-color);
  }

  .share-menu i {
    margin-right: 0.5rem;
    width: 20px;
    text-align: center;
  }

  /* Comments Section */
  .comments-section {
    background-color: white;
    border-radius: 8px;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    overflow: hidden;
  }

  .comments-header {
    padding: 1rem 1.5rem;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    justify-content: space-between;
    align-items: center;
  }

  .comments-header h3 {
    font-size: 1.25rem;
    color: var(--primary-dark);
  }

  .comments-count {
    background-color: var(--secondary-color);
    color: var(--primary-dark);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-size: 0.875rem;
  }

  .comment-form {
    padding: 1.5rem;
    border-bottom: 1px solid var(--border-color);
  }

  .comment-input {
    display: flex;
    gap: 1rem;
  }

  .comment-avatar {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    background-color: #e0e0e0;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
  }

  .comment-textarea {
    flex-grow: 1;
    border: 1px solid var(--border-color);
    border-radius: 4px;
    padding: 0.75rem;
    resize: none;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s;
  }

  .comment-textarea:focus {
    border-color: var(--primary-color);
  }

  .comment-actions {
    display: flex;
    justify-content: flex-end;
    margin-top: 0.5rem;
  }

  .submit-comment {
    background-color: var(--primary-color);
    color: white;
    border: none;
    padding: 0.5rem 1rem;
    border-radius: 4px;
    cursor: pointer;
    font-weight: 500;
    transition: background-color 0.2s;
  }

  .submit-comment:hover {
    background-color: var(--primary-dark);
  }

  .comments-list {
    padding: 0 1.5rem;
  }

  .comment {
    padding: 1.5rem 0;
    border-bottom: 1px solid var(--border-color);
    display: flex;
    gap: 1rem;
  }

  .comment:last-child {
    border-bottom: none;
  }

  .comment-body {
    flex-grow: 1;
  }

  .comment-author {
    font-weight: 500;
    margin-bottom: 0.25rem;
  }

  .comment-text {
    margin-bottom: 0.5rem;
    line-height: 1.5;
    font-size: 0.95rem;
  }

  .comment-meta {
    display: flex;
    color: #777;
    font-size: 0.8rem;
  }

  .comment-date {
    margin-right: 1rem;
  }

  .comment-reply {
    color: var(--primary-color);
    cursor: pointer;
    outline: none;
    border: none;
    background: none;
  }

  .reply-form {
    margin-top: 1rem;
    margin-left: 2.5rem;
    display: none;
  }

  .reply-form.active {
    display: block;
  }

  .nested-comment {
    margin-top: 1rem;
    margin-left: 2.5rem;
    padding-top: 1rem;
    border-top: 1px solid var(--border-color);
  }

  /* Responsive Design */
  @media (max-width: 768px) {
    header {
      padding: 1rem;
    }

    .logo-text h1 {
      font-size: 1.2rem;
    }

    nav a {
      padding: 0.5rem;
    }

    .post-header,
    .post-content {
      padding: 1rem;
    }

    .post-title {
      font-size: 1.25rem;
    }

    .post-meta {
      flex-direction: column;
      align-items: flex-start;
    }

    .post-author {
      margin-bottom: 0.5rem;
    }

    .post-actions {
      flex-wrap: wrap;
    }
  }
</style>
{% endblock %} {% block content %}
<div class="main-content">
  <div class="container">

    <!-- Breadcrumb -->
    <div class="breadcrumb">
        <a href="{% url 'appCmi:home' %}"><i class="fas fa-home"></i> Home</a>
        <span>/</span>
        <a href="{% url 'appCmi:cmi-forum' %}">Forum</a>
        <span>/</span>
        {% for commodity in display_forum.commodity_id.all %}
            <a href="#">{{ commodity }}</a>
            {% if not forloop.last %} & {% endif %}
        {% endfor %}
    </div>
    

    <!-- Post Container -->
    <div class="post-container">
      <div class="post-header">
        <h1 class="post-title">
          {{display_forum.forum_title|upper}}
          <i class="fas fa-seedling"></i>
        </h1>
        <div class="post-category">
            {% for commodity in display_forum.commodity_id.all %}
                      <a href="#" class="post-tag">
                           {{ commodity }}
                      </a>
                  {% endfor %}
        </div>
        <div class="post-meta">
          <div class="post-author">
            <div class="author-avatar">
              <img src="/api/placeholder/100/100" alt="Author" />
            </div>
            <span>{{display_forum.author.first_name|capfirst}} {{display_forum.author.last_name|capfirst}}</span>
          </div>
          <div class="post-date">
            <i class="far fa-calendar-alt"></i>
            <span>{{display_forum.date_posted|date:"F d, Y"}}</span>
          </div>
        </div>
      </div>

      <div class="post-content">
        <p>{{display_forum.forum_question|linebreaksbr|safe}}</p>
        
      </div>

      <div class="post-actions">
        <button class="action-button {% if display_forum.is_liked_by %}liked{% endif %}" 
          id="likeButton" 
          data-forum-slug="{{ display_forum.slug }}" 
          data-like-url="{% url 'appCmi:toggle-forum-like' 'dummy-slug' %}"
          {% if display_forum.is_liked_by %}disabled{% endif %}>
          <i class="fa{% if display_forum.is_liked_by %}s{% else %}r{% endif %} fa-thumbs-up {% if display_forum.is_liked_by %}text-success{% endif %}"></i>
          <span>Like</span>
          <span class="like-count">({{ display_forum.total_likes }})</span>
        </button>


        <button class="action-button" id="commentButton">
          <i class="far fa-comment-alt"></i>
          <span>Comment</span>
          <span class="comment-count">({{comment_counts}})</span>
        </button>
        
        <button class="action-button {% if display_forum.is_bookmarked_by %}bookmarked{% endif %}" 
          id="saveButton" 
          data-forum-slug="{{ display_forum.slug }}" 
          data-bookmark-url="{% url 'appCmi:toggle-forum-bookmark' 'dummy-slug' %}"
          {% if display_forum.is_bookmarked_by %}disabled{% endif %}>
          <i class="fa{% if display_forum.is_bookmarked_by %}s{% else %}r{% endif %} fa-bookmark {% if display_forum.is_bookmarked_by %}text-success{% endif %}"></i>
          <span>{% if display_forum.is_bookmarked_by %}Saved{% else %}Save{% endif %}</span>
        </button>


        <div class="share-dropdown">
          <button class="action-button" id="shareButton">
            <i class="fas fa-share-alt"></i>
            <span>Share</span>
          </button>
          <div class="share-menu" id="shareMenu">
            <a href="#" class="share-facebook">
              <i class="fab fa-facebook"></i>
              <span>Facebook</span>
            </a>
            <a href="#" class="share-twitter">
              <i class="fab fa-twitter"></i>
              <span>Twitter</span>
            </a>
            <a href="#" class="share-linkedin">
              <i class="fab fa-linkedin"></i>
              <span>LinkedIn</span>
            </a>
            <a href="#" class="share-whatsapp">
              <i class="fab fa-whatsapp"></i>
              <span>WhatsApp</span>
            </a>
            <a href="#" class="share-email">
              <i class="fas fa-envelope"></i>
              <span>Email</span>
            </a>
          </div>
        </div>
      </div>
    </div>

    <!-- Comments Section -->
    <div class="comments-section">
      <div class="comments-header">
        <h3>Comments</h3>
        <div class="comments-count">18</div>
      </div>

      <form method="post" action="{% url 'appCmi:forum-add-comment' display_forum.slug %}" id="comment-form">
        {% csrf_token %}
        <div class="comment-form">
          <div class="comment-input">
            <div class="comment-avatar">
              {% if request.user.profile_image %}
                <img src="{{ request.user.profile_image.url }}" alt="{{ request.user.username }}">
              {% else %}
                <i class="fas fa-user"></i>
              {% endif %}
            </div>
            <textarea name="content" class="comment-textarea" placeholder="Write a comment...">{{ form.content.value|default_if_none:"" }}</textarea>
            <input type="hidden" name="parent" value="{{ form.parent.value|default_if_none:"" }}">
          </div>
          <div class="comment-actions">
            <button type="submit" class="submit-comment">Post Comment</button>
          </div>
        </div>
      </form>

      <div class="comments-list">
        {% for comment in comments %}
        <div class="comment" data-comment-slug="{{ comment.slug }}">
            <div class="author-avatar">
                <img src="/api/placeholder/100/100" alt="Commenter" />
            </div>
        
            <div class="comment-body">
                <div class="comment-author">{{comment.user.first_name|capfirst}} {{comment.user.last_name|capfirst}}</div>
                <div class="comment-text">
                    {{comment.content}}
                </div>
                <div class="comment-meta">
                    <div class="comment-date">{{comment.created_at|date:"F d, Y"}}</div>
                    <div class="comment-actions">
                        <button class="comment-reply" data-comment-slug="{{ comment.slug }}">
                            <i class="fas fa-reply"></i> Reply
                        </button>
                    </div>
                </div>
        
                <div class="reply-form" style="display: none;">
                    <form method="post" action="{% url 'appCmi:forum-add-comment' display_forum.slug %}">
                        {% csrf_token %}
                        <div class="comment-input">
                            <textarea name="content" class="comment-textarea" placeholder="Write a reply..."></textarea>
                            <input type="hidden" name="parent" value="">
                        </div>
                        <div class="comment-actions">
                            <button type="submit" class="submit-comment reply-button">Reply</button>
                        </div>
                    </form>
                </div>
                
                <!-- Display replies -->
                {% if comment.replies.all %}
                    <div class="replies">
                        {% for reply in comment.replies.all %}
                            <div class="comment reply" data-comment-slug="{{ reply.slug }}">
                                <div class="author-avatar">
                                    <img src="/api/placeholder/100/100" alt="Commenter" />
                                </div>
                                <div class="comment-body">
                                    <div class="comment-author">{{reply.user.first_name|capfirst}} {{reply.user.last_name|capfirst}}</div>
                                    <div class="comment-text">
                                        {{reply.content}}
                                    </div>
                                    <div class="comment-meta">
                                        <div class="comment-date">{{reply.created_at|date:"F d, Y"}}</div>
                                        <div class="comment-actions">
                                            <button class="like-button {% if reply.is_liked_by|default_if_none:False %}liked{% endif %}" 
                                                    data-comment-slug="{{ reply.slug }}">
                                                <i class="fa{% if reply.is_liked_by|default_if_none:False %}s{% else %}r{% endif %} fa-thumbs-up"></i>
                                                <span class="like-count">{{ reply.total_likes }}</span>
                                            </button>
                                            <button class="comment-reply" data-comment-slug="{{ reply.slug }}">
                                                <i class="fas fa-reply"></i> Reply
                                            </button>
                                        </div>
                                    </div>
                                    
                                    <div class="reply-form" style="display: none;">
                                        <form method="post" action="{% url 'appCmi:forum-add-comment' display_forum.slug %}">
                                            {% csrf_token %}
                                            <div class="comment-input">
                                                <textarea name="content" class="comment-textarea" placeholder="Write a reply..."></textarea>
                                                <input type="hidden" name="parent" value="">
                                            </div>
                                            <div class="comment-actions">
                                                <button type="submit" class="submit-comment reply-button">Reply</button>
                                            </div>
                                        </form>
                                    </div>
                                    
                                    <!-- Recursively display nested replies if needed -->
                                    {% if reply.replies.all %}
                                        <div class="replies">
                                            <!-- You could include a template here for recursive rendering -->
                                        </div>
                                    {% endif %}
                                </div>
                            </div>
                        {% endfor %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endfor %}
      </div>
    </div>
  </div>
</div>
{% endblock %} 
{% block script %}
<script>
   // Forum comments and interactions script
document.addEventListener('DOMContentLoaded', function() {
  // Toggle share menu
  const shareButton = document.getElementById('shareButton');
  const shareMenu = document.getElementById('shareMenu');
  const likeButton = document.getElementById('likeButton');
  const saveButton = document.getElementById('saveButton');

  if (shareButton && shareMenu) {
      shareButton.addEventListener('click', function() {
          shareMenu.classList.toggle('active');
      });

      // Close the share menu when clicking outside
      document.addEventListener('click', function(event) {
          if (!shareButton.contains(event.target) && !shareMenu.contains(event.target)) {
              shareMenu.classList.remove('active');
          }
      });
  }

  // Like button functionality
  if (likeButton) {
    likeButton.addEventListener('click', function () {
        const forumSlug = this.dataset.forumSlug;
        let likeUrl = this.dataset.likeUrl.replace('dummy-slug', forumSlug);

        const likeIcon = this.querySelector('i');
        const likeCount = this.querySelector('.like-count');

        fetch(likeUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Update like count
                likeCount.textContent = `(${data.total_likes})`;

                // Toggle like status
                if (data.is_liked) {
                    likeIcon.classList.remove('far');
                    likeIcon.classList.add('fas');
                    this.classList.add('liked');
                } else {
                    likeIcon.classList.remove('fas');
                    likeIcon.classList.add('far');
                    this.classList.remove('liked');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            alert('There was an error processing your like');
        });
    });
  }

  // Save button functionality
  if (saveButton && !saveButton.disabled) { // Attach event only if button is enabled
    saveButton.addEventListener('click', function () {
        const forumSlug = this.dataset.forumSlug;
        let bookmarkUrl = this.dataset.bookmarkUrl.replace('dummy-slug', forumSlug);

        const bookmarkIcon = this.querySelector('i');
        const buttonText = this.querySelector('span');

        fetch(bookmarkUrl, {
            method: 'POST',
            headers: {
                'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value,
                'X-Requested-With': 'XMLHttpRequest'
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                if (data.is_bookmarked) {
                    bookmarkIcon.classList.remove('far');
                    bookmarkIcon.classList.add('fas', 'text-success');
                    buttonText.textContent = 'Saved';
                    this.disabled = true; // Disable button after bookmarking
                    showToast('Post saved to bookmarks');
                }
            }
        })
        .catch(error => {
            console.error('Error:', error);
            showToast('Error saving bookmark', 'error');
        });
    });
  }

  // Social media share functionality (dummy for now)
  const shareLinks = document.querySelectorAll('.share-menu a');
  shareLinks.forEach(link => {
      link.addEventListener('click', function(e) {
          e.preventDefault();
          const platform = this.querySelector('span').textContent;
          alert(`Sharing to ${platform}... 
          This would typically open a ${platform} sharing dialog in a production environment.`);
          shareMenu.classList.remove('active');
      });
  });

  // Initialize reply buttons for all comments including nested ones
  initializeReplyButtons();

  // Function to initialize reply buttons
  function initializeReplyButtons() {
      const replyButtons = document.querySelectorAll('.comment-reply');
      replyButtons.forEach(button => {
          // Remove any existing event listeners to prevent duplicates
          const newButton = button.cloneNode(true);
          button.parentNode.replaceChild(newButton, button);
          
          newButton.addEventListener('click', function(e) {
              e.preventDefault();
              
              // Get the parent comment slug
              const commentContainer = this.closest('.comment');
              const commentSlug = commentContainer.dataset.commentSlug;
              
              // Close all other open reply forms first
              document.querySelectorAll('.reply-form').forEach(form => {
                  if (form !== this.closest('.comment-body').querySelector('.reply-form')) {
                      form.style.display = 'none';
                  }
              });
              
              // Toggle current reply form
              const replyForm = this.closest('.comment-body').querySelector('.reply-form');
              if (replyForm.style.display === 'none' || replyForm.style.display === '') {
                  replyForm.style.display = 'block';
                  
                  // Set the parent comment slug in the hidden input
                  const parentInput = replyForm.querySelector('input[name="parent"]');
                  if (parentInput) {
                      parentInput.value = commentSlug;
                  }
                  
                  // Focus on the textarea
                  replyForm.querySelector('textarea').focus();
              } else {
                  replyForm.style.display = 'none';
              }
          });
      });
  }

  // Add form submission via AJAX for a smoother experience
  setupAjaxCommentSubmission();
});

function setupAjaxCommentSubmission() {
  const csrfToken = document.querySelector('input[name="csrfmiddlewaretoken"]').value;
  const mainCommentForm = document.getElementById('comment-form');
  const replyForms = document.querySelectorAll('.reply-form form');
  
  if (mainCommentForm) {
      mainCommentForm.addEventListener('submit', handleFormSubmit);
  }
  
  replyForms.forEach(form => {
      form.addEventListener('submit', handleFormSubmit);
  });
  
  function handleFormSubmit(e) {
      e.preventDefault();
      
      const form = this;
      const formData = new FormData(form);
      const url = form.getAttribute('action');
      
      // Check if we have content
      const content = formData.get('content');
      if (!content || content.trim() === '') {
          alert('Please enter a comment before submitting.');
          return;
      }
      
      // Submit using fetch API
      fetch(url, {
          method: 'POST',
          body: formData,
          headers: {
              'X-Requested-With': 'XMLHttpRequest',
              'X-CSRFToken': csrfToken
          }
      })
      .then(response => {
          if (response.ok) {
              // First check if the response is JSON
              const contentType = response.headers.get('content-type');
              if (contentType && contentType.includes('application/json')) {
                  return response.json();
              } else {
                  // If not JSON, reload the page to show the changes
                  window.location.reload();
                  return { success: true };
              }
          } else {
              throw new Error('Network response was not ok');
          }
      })
      .then(data => {
          if (data.success) {
              // Reset the form
              form.reset();
              
              // If this is a reply form, hide it
              if (form.closest('.reply-form')) {
                  form.closest('.reply-form').style.display = 'none';
              }
              
              // Update comment count
              updateCommentsCount(true);
              
              // For simplicity, we'll reload the page to show the new comment
              window.location.reload();
          } else {
              console.error('Error response from server:', data);
              alert('There was an error posting your comment.');
          }
      })
      .catch(error => {
          console.error('Error:', error);
          
          // Even with an error, it might actually have been saved in the database
          // So we'll reload to check, but also show the error
          alert('There may have been an issue with your comment submission. The page will reload to check if it was saved.');
          window.location.reload();
      });
  }
}

// Helper function to update comments count
function updateCommentsCount(increment = true) {
  const commentsCount = document.querySelector('.comments-count');
  if (commentsCount) {
      const currentCount = parseInt(commentsCount.textContent);
      commentsCount.textContent = increment ? (currentCount + 1) : (currentCount - 1);
  }
  
  const commentCount = document.querySelector('.comment-count');
  if (commentCount) {
      const currentCount = parseInt(commentCount.textContent.replace(/[()]/g, ''));
      commentCount.textContent = `(${increment ? (currentCount + 1) : (currentCount - 1)})`;
  }
}

// Add observer for dynamically added comments that might need reply functionality
function setupMutationObserver() {
  // Create an observer instance linked to a callback function
  const observer = new MutationObserver((mutations) => {
      let shouldReinitializeButtons = false;
      
      mutations.forEach((mutation) => {
          if (mutation.type === 'childList' && mutation.addedNodes.length > 0) {
              // Check if any of the added nodes are comments or contain comments
              mutation.addedNodes.forEach((node) => {
                  if (node.classList && node.classList.contains('comment')) {
                      shouldReinitializeButtons = true;
                  } else if (node.querySelector && node.querySelector('.comment')) {
                      shouldReinitializeButtons = true;
                  }
              });
          }
      });
      
      if (shouldReinitializeButtons) {
          // Reinitialize reply buttons when new comments are added
          initializeReplyButtons();
      }
  });
  
  // Start observing the comments list for changes
  const commentsList = document.querySelector('.comments-list');
  if (commentsList) {
      observer.observe(commentsList, { childList: true, subtree: true });
  }
}

// Call this function to set up the observer if needed
// setupMutationObserver();
</script>
{% endblock script %}
